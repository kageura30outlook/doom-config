#+TITLE: My Doom Emacs Config
#+PROPERTY: header-args:emacs-lisp :tangle config.el
#+AUTHOR: kageura30outlook

* Introduction
This is my literate Doom Emacs configuration.
All code blocks here are tangled into config.el.

* Basic Settings

#+begin_src emacs-lisp
;;; $DOOMDIR/config.el -*- lexical-binding: t; -*-

(setq evil-respect-visual-line-mode t)

;; Disable org-persist completely
(setq org-element-cache-persistent nil)
(setq org-persist-directory nil)
(setq org-persist-default-directory nil)

(when (not (featurep 'org-persist))
  (defun org-persist-write (&rest _) nil)
  (defun org-persist-read (&rest _) nil)
  (defun org-persist-load (&rest _) nil)
  (defun org-persist-register (&rest _) nil)
  (defun org-persist-unregister (&rest _) nil)
  (defun org-persist-gc (&rest _) nil)
  (defun org-persist-clear-storage (&rest _) nil)
  (provide 'org-persist))

(with-eval-after-load 'org
  (setq org-element-cache-persistent nil)
  (setq org-persist-directory nil))

;; Place your private configuration here! Remember, you do not need to run 'doom
;; sync' after modifying this file!

;; Some functionality uses this to identify you, e.g. GPG configuration, email
;; clients, file templates and snippets. It is optional.
#+end_src

* Theme and UI

Configure the visual appearance:

#+begin_src emacs-lisp
;; Load Doom theme
(setq doom-theme 'doom-monokai-ristretto)
(doom/set-frame-opacity 80)
(when doom-theme
  (load-theme doom-theme t))

;; Line numbers style
(setq display-line-numbers-type t)
#+end_src

* MCP Servers
#+begin_src emacs-lisp
;; Ensure `mcp.el` directory is correctly located in the `.doom.d/` folder.
(add-to-list 'load-path (expand-file-name "~/.doom.d/mcp.el")) ;; If mcp.el is a directory, change accordingly

(use-package! mcp
  :after gptel
  :custom
  (mcp-hub-servers
   '(("filesystem" . (:command "npx" :args ("-y" "@modelcontextprotocol/server-filesystem" "/Users/Kageura/")))
     ("fetch" . (:command "npx" :args ("-y" "@modelcontextprotocol/server-fetch")))
     ("memory" . (:command "npx" :args ("-y" "@pulsemcp/basic-memory")))
     ("sequencethink" . (:command "npx" :args ("-y" "@arben-adm/mcp-sequential-thinking")))
     ("git" . (:command "npx" :args ("-y" "@modelcontextprotocol/server-github")))
     ("python-sdk" . (:command "python3" :args ("-m" "mcp.server.fastmcp" "--spec" "python-sdk")))
     ("puppeteer" . (:command "npx" :args ("-y" "@modelcontextprotocol/server-puppeteer")))
     ("emacs" . (:command "bash" :args ("-c" "~/.config/doom/bin/doomscript ~/.config/doom/bin/emacs-mcp")))))
  :config
  (require 'mcp-hub)
  (add-hook 'after-init-hook #'mcp-hub-start-all-server))
#+end_src

* Meta key setup
#+begin_src emacs-lisp
(setq mac-command-modifier 'super
      ns-command-modifier 'super
      mac-option-modifier 'meta
      ns-option-modifier 'meta
      mac-left-option-modifier 'meta)
#+end_src

* Font Configuration

Configure fonts based on the hardware:

#+begin_src emacs-lisp
;; Doom exposes five (optional) variables for controlling fonts in Doom:
;;
;; - `doom-font' -- the primary font to use
;; - `doom-variable-pitch-font' -- a non-monospace font (where applicable)
;; - `doom-big-font' -- used for `doom-big-font-mode'; use this for
;;   presentations or streaming.
;; - `doom-serif-font' -- for the `fixed-pitch-serif' face
;;
;; „Éó„É©„ÉÉ„Éà„Éï„Ç©„Éº„É†‰æùÂ≠ò„ÅÆ„Éï„Ç©„É≥„ÉàË®≠ÂÆö
(cond
 ((eq system-type 'darwin)  ; macOS
  (let ((device-name (shell-command-to-string "sysctl -n hw.model")))
    (cond
     ((string-match-p "Mac15,12" device-name)
      (setq doom-font (font-spec :family "Monaspace Argon" :size 12)))
     (t
      (setq doom-font (font-spec :family "Monaspace Argon" :size 14))))))
 ((eq system-type 'gnu/linux)  ; Linux
  (setq doom-font (font-spec :family "Source Code Pro" :size 14)))
 (t  ; „Åù„ÅÆ‰ªñ„ÅÆ„Ç∑„Çπ„ÉÜ„É†
  (setq doom-font (font-spec :family "monospace" :size 14))))

;; Japanese and symbol font support („Éó„É©„ÉÉ„Éà„Éï„Ç©„Éº„É†ÂØæÂøú)
(setq doom-symbol-font
  (cond
   ((eq system-type 'darwin) (font-spec :family "Noto Sans JP"))
   ((eq system-type 'gnu/linux) (font-spec :family "Noto Sans CJK JP"))
   (t (font-spec :family "sans-serif"))))
#+end_src

* Lines
#+begin_src emacs-lisp
(map! :leader
      :desc "Toggle truncate lines"
      "t t" #'toggle-truncate-lines)
#+end_src

* Org Mode Configuration

Basic org-mode setup:

#+begin_src emacs-lisp
;; If you use `org' and don't want your org files in the default location below,
;; change `org-directory'. It must be set before org loads!
(setq org-directory "~/org/")

;; Source block fontification
(setq org-src-fontify-natively t)
#+end_src

** Org Basic Config

#+begin_src emacs-lisp
(after! org
  (setq org-startup-folded 'show2levels)

  (defun my/unfold-toc-section ()
    (when (eq major-mode 'org-mode)
      (save-excursion
        (goto-char (point-min))
        (when (re-search-forward "^\\*+ Table of Contents" nil t)
          (org-show-subtree)))))

  (add-hook 'org-mode-hook #'my/unfold-toc-section))
#+end_src

** Org Export and LaTeX

#+begin_src emacs-lisp
;; tex settings
(setq texprogram 'dvipng)

(after! org
  (setq org-html-head-include-scripts t
        ;; xxelatex1
        org-latex-pdf-process
        '("lualatex -shell-escape -interaction nonstopmode -output-directory %o %f"
          "biber %b"
          "lualatex -shell-escape -interaction nonstopmode -output-directory %o %f"
          "lualatex -shell-escape -interaction nonstopmode -output-directory %o %f")
        ;; org-latex-pdf-process (list "latexmk -shell-escape -f -lualatex %f")
        org-preview-latex-default-process 'imagexetex
        org-export-with-toc t
        org-export-headline-levels 4
        org-pandoc-options '((standalone . t) (self-contained . t))
        org-latex-create-formula-image-program texprogram
        org-export-with-author t
        org-export-headline-levels 1
        org-export-with-drawers nil
        org-export-with-email t
        org-export-with-footnotes t
        org-export-with-sub-superscripts nil
        org-export-with-latex t
        org-export-with-properties nil
        org-export-with-smart-quotes t))
(after! org (add-to-list 'org-latex-packages-alist '("" "mathrsfs" t)))

;; „Éó„É©„ÉÉ„Éà„Éï„Ç©„Éº„É†‰æùÂ≠ò„ÅÆbibliography„Éë„Çπ
(setq! bibtex-completion-bibliography
  (list (expand-file-name "bibliography.bib" "~")))
(setq! citar-bibliography
  (list (expand-file-name "bibliography.bib" "~")))
#+end_src

* Org Roam V2
My knowledge management system using Org-Roam v2.

#+begin_src emacs-lisp
(use-package! org-roam
  :init
  (setq org-roam-v2-ack t)  ;; acknowledge v2
  :custom
  (org-roam-directory (file-truename "~/org-roam"))
  (org-roam-completion-everywhere t)
  :config
  (org-roam-db-autosync-enable)
  (map! :leader
        :prefix "n"
        :desc "Find node" "r f" #'org-roam-node-find
        :desc "Insert node" "r i" #'org-roam-node-insert
        :desc "Show graph" "r g" #'org-roam-graph
        :desc "Capture node" "r c" #'org-roam-capture))
#+end_src

* File Management

** File Insertion Utilities

Utilities for inserting file paths:

#+begin_src emacs-lisp
(defun find-file-insert (filename &optional wildcards)
  "Insert the selected file name at the current point."
  (interactive
   (find-file-read-args "Find file: "
                        (confirm-nonexistent-file-or-buffer)))
  (insert filename))

(defun find-file-insert-relative (filename &optional wildcards)
  "Insert the relative filename of the selected file at the current point."
  (interactive
   (find-file-read-args "Find file: "
                        (confirm-nonexistent-file-or-buffer)))
  (let* ((current-buffer (buffer-file-name (current-buffer)))
         (directory (file-name-directory current-buffer))
         (relative-filename (file-relative-name filename directory)))
    (insert relative-filename)))

(map! :leader
      :desc "Insert selected file name at point" "if" #'find-file-insert
      :desc "Insert selected file name at point" "ir" #'find-file-insert-relative)
#+end_src

** Dired Configuration

#+begin_src emacs-lisp
(evil-define-key 'normal peep-dired-mode-map (kbd "<SPC>") 'peep-dired-scroll-page-down
  (kbd "C-<SPC>") 'peep-dired-scroll-page-up
  (kbd "<backspace>") 'peep-dired-scroll-page-up
  (kbd "j") 'peep-dired-next-file
  (kbd "k") 'peep-dired-prev-file)

(add-hook 'peep-dired-hook 'evil-normalize-keymaps)
(setq peep-dired-ignored-extensions '("mkv" "iso" "mp4"))
(setq peep-dired-cleanup-on-disable t)
(setq peep-dired-enable-on-directories t)

;; Add the key binding SPC d p to toggle peep-dired-mode while in dired (you can add the key binding you like)
(map! :leader
      (:after dired
              (:map dired-mode-map
               :desc "peep mode" "d p" #'peep-dired)))

(use-package! dired-git-info
  :after dired
  :config
  (add-hook 'dired-after-readin-hook 'dired-git-info-auto-enable)
  )
#+end_src

* Org Mode Advanced Features

** Org Folding System

#+begin_src emacs-lisp
(after! org
  (defun orgfold-get-fold-info-file-name ()
    (concat (buffer-file-name) ".fold"))

  (defun orgfold-save ()
    (when (and (buffer-file-name)
               (file-exists-p (orgfold-get-fold-info-file-name)))
      (save-excursion
        (goto-char (point-min))
        (let (foldstates)
          (unless (looking-at outline-regexp)
            (outline-next-visible-heading 1))
          (while (not (eobp))
            (push (when (seq-some (lambda (o) (overlay-get o 'invisible))
                                  (overlays-at (line-end-position)))
                    t)
                  foldstates)
            (outline-next-visible-heading 1))
          (with-temp-file (orgfold-get-fold-info-file-name)
            (prin1 (nreverse foldstates) (current-buffer)))))))

  (defun orgfold-restore ()
    (when (buffer-file-name)
      (save-excursion
        (goto-char (point-min))
        (let* ((foldfile (orgfold-get-fold-info-file-name))
               (foldstates
                (when (file-readable-p foldfile)
                  (with-temp-buffer
                    (insert-file-contents foldfile)
                    (when (> (buffer-size) 0)
                      (read (current-buffer)))))))
          (when foldstates
            (show-all)
            (goto-char (point-min))
            (unless (looking-at outline-regexp)
              (outline-next-visible-heading 1))
            (while (and foldstates
                        (not (eobp)))
              (when (pop foldstates)
                (hide-subtree))
              (outline-next-visible-heading 1)))))))

  (defun orgfold-init ()
    (interactive)
    (when (buffer-file-name)
      (save-excursion
        (goto-char (point-min))
        (let (foldstates)
          (unless (looking-at outline-regexp)
            (outline-next-visible-heading 1))
          (while (not (eobp))
            (push (when (seq-some (lambda (o) (overlay-get o 'invisible))
                                  (overlays-at (line-end-position)))
                    t)
                  foldstates)
            (outline-next-visible-heading 1))
          (with-temp-file (orgfold-get-fold-info-file-name)
            (prin1 (nreverse foldstates) (current-buffer)))))
      (add-hook 'after-save-hook #'orgfold-save nil t)
      (message "Fold state tracking initialized for %s" (buffer-name))))

  (defun orgfold-activate ()
    (when (and (buffer-file-name)
               (file-exists-p (orgfold-get-fold-info-file-name)))
      (orgfold-restore)
      (add-hook 'after-save-hook #'orgfold-save nil t)))

  ;; „Ç≠„Éº„Éê„Ç§„É≥„Éâ„ÅÆË®≠ÂÆö
  (map! :map org-mode-map
        :leader
        :prefix ("m" . "org")
        :desc "Initialize fold tracking" "f" #'orgfold-init)

  (add-hook 'org-mode-hook #'orgfold-activate)
  ;; (add-hook 'org-mode-hook #'org-modern-mode)  ; Temporarily disabled for testing
  )
#+end_src

** Org Roam Configuration

Org Roam provides a networked note-taking system inspired by Roam Research and Zettelkasten:

#+begin_src emacs-lisp
;; Org Roam - Second Brain Note Taking System
(use-package! org-roam
  :ensure t
  :custom
  (org-roam-directory "~/Documents/RoamNotes")
  (org-roam-db-location (expand-file-name "org-roam.db" doom-cache-dir))
  (org-roam-completion-everywhere t)
  (org-roam-dailies-directory "daily/")
  (org-roam-node-display-template
   (concat "${title:*} "
           (propertize "${tags:10}" 'face 'org-tag)))
  :bind (("C-c n l" . org-roam-buffer-toggle)
         ("C-c n f" . org-roam-node-find)
         ("C-c n i" . org-roam-node-insert)
         ("C-c n d n" . org-roam-dailies-capture-today)
         ("C-c n d d" . org-roam-dailies-goto-today)
         ("C-c n d Y" . org-roam-dailies-capture-yesterday)
         ("C-c n d T" . org-roam-dailies-capture-tomorrow)
         ("C-c n d v" . org-roam-dailies-capture-date)
         ("C-c n d c" . org-roam-dailies-goto-date)
         :map org-mode-map
         ("C-M-i" . completion-at-point))
  :config
  (org-roam-setup)

  ;; Capture templates
  (setq org-roam-capture-templates
        '(("d" "default" plain
           "%?"
           :if-new (file+head "%<%Y%m%d%H%M%S>-${slug}.org" "#+title: ${title}\n#+date: %U\n#+filetags: :memo:\n\n")
           :unnarrowed t)
          ("l" "programming language" plain
           "* Characteristics\n\n- Family: %?\n- Inspired by: \n\n* Reference:\n\n"
           :if-new (file+head "%<%Y%m%d%H%M%S>-${slug}.org" "#+title: ${title}\n#+filetags: :Programming:\n\n")
           :unnarrowed t)
          ("b" "book notes" plain
           "\n* Source\n\nAuthor: %^{Author}\nTitle: ${title}\nYear: %^{Year}\n\n* Memos\n\n%?"
           :if-new (file+head "%<%Y%m%d%H%M%S>-${slug}.org" "#+title: ${title}\n#+filetags: :Book:\n\n")
           :unnarrowed t)
          ("m" "mathematical concept" plain
           "* References\n"
           :target (file+head "%<%Y%m%d%H%M%S>-${slug}.org"
                           "#+title: ${title}\n#+date: %U\n#+filetags: :math:memo:\n\n")
           :unnarrowed t)
          ("r" "research paper" plain
           "* Bibliographic Information\n- Author: %?\n- Title: ${title}\n- Year: \n- Journal/Conference: \n- DOI/URL: \n\n* Abstract\n\n* Key Contributions\n\n* Methodology\n\n* Results\n\n* Personal Notes\n\n* Related Work\n\n* Applications\n"
          :target (file+head "%<%Y%m%d%H%M%S>-${slug}.org"
                           "#+title: ${title}\n#+date: %U\n#+filetags: :paper:research:\n\n")
           :unnarrowed t)
          ("M" "MOC (Map of Content)" plain
           "* Overview\n%?\n\n* Core Concepts\n\n* Advanced Topics\n\n* Applications\n\n* Learning Path\n\n* Resources\n"
           :target (file+head "%<%Y%m%d%H%M%S>-${slug}.org"
                           "#+title: ${title} \n#+date: %U\n#+filetags: :MOC:\n\n")
           :unnarrowed t)
          ("p" "project" plain
           "* Goals\n\n%?\n\n* Tasks\n\n** TODO Add initial tasks\n\n* Dates\n\n"
           :if-new (file+head "%<%Y%m%d%H%M%S>-${slug}.org" "#+title: ${title}\n\n#+date: %U\n#+filetags: :Project:\n\n")
           :unnarrowed t)
          ("s" "study project" plain
           "* Goals\n\n%?\n\n* Tasks\n\n** TODO Add initial tasks\n\n* Dates\n\n"
           :if-new (file+head "%<%Y%m%d%H%M%S>-${slug}.org" "#+title: ${title}\n\n#+date: %U\n#+filetags: :Study:\n\n")
           :unnarrowed t)
          ("n" "meeting minutes" plain
          "* Meeting Information\n- Topic: %^{Meeting Topic}\n- Start Time: %^{Start Time}\n- Attendees: %^{Attendees}\n\n* Agenda\n%?\n\n* Discussion\n\n* Checks\n** TODO\n"
          :if-new (file+head "%<%Y%m%d%H%M%S>-${slug}.org" "#+title: ${title}\n#+date: %U\n#+filetags: :minutes:\n\n")
          :unnarrowed t)))

  ;; Daily notes capture templates
  (setq org-roam-dailies-capture-templates
        '(("d" "default" entry "* %<%I:%M %p>: %?"
           :if-new (file+head "%<%Y-%m-%d>.org" "#+title: %<%Y-%m-%d>\n#+filetags: :daily:\n\n"))))

  ;; Quick note insertion function
  (defun org-roam-node-insert-immediate (arg &rest args)
    "Insert a new org-roam node without opening its buffer."
    (interactive "P")
    (let ((args (cons arg args))
          (org-roam-capture-templates
           (list (append (car org-roam-capture-templates)
                         '(:immediate-finish t)))))
      (apply #'org-roam-node-insert args)))

  ;; Project management functions
  (defun org-roam-filter-by-tag (tag-name)
    "Filter org-roam nodes by tag."
    (mapcar #'org-roam-node-file
            (seq-filter
             (lambda (node)
               (member tag-name (org-roam-node-tags node)))
             (org-roam-node-list))))

  (defun org-roam-list-notes-by-tag (tag-name)
    "List all notes with specified tag."
    (mapcar #'org-roam-node-title
            (seq-filter
             (lambda (node)
               (member tag-name (org-roam-node-tags node)))
             (org-roam-node-list))))

  ;; Key bindings for doom - Á¢∫ÂÆü„Å´org-roam„ÅÆÂæå„Å´Ë®≠ÂÆö
  (after! org-roam
    (map! :leader
          :prefix ("n" . "notes")
          :desc "Org roam buffer toggle" "l" #'org-roam-buffer-toggle
          :desc "Find node" "f" #'org-roam-node-find
          :desc "Insert node" "i" #'org-roam-node-insert
          :desc "Insert node immediate" "I" #'org-roam-node-insert-immediate
          (:prefix ("d" . "daily")
           :desc "Capture today" "n" #'org-roam-dailies-capture-today
           :desc "Goto today" "d" #'org-roam-dailies-goto-today
           :desc "Capture yesterday" "Y" #'org-roam-dailies-capture-yesterday
           :desc "Capture tomorrow" "T" #'org-roam-dailies-capture-tomorrow
           :desc "Capture date" "v" #'org-roam-dailies-capture-date
           :desc "Goto date" "c" #'org-roam-dailies-goto-date)))

  ;; org-roam„ÇíÁ¢∫ÂÆü„Å´ÂàùÊúüÂåñ
  (add-hook 'after-init-hook #'org-roam-db-autosync-mode)

  ;; org-roam autosync „ÅÆÂº∑ÂåñË®≠ÂÆö
  (setq org-roam-db-update-on-file-change t)

  ;; „Éï„Ç°„Ç§„É´‰øùÂ≠òÊôÇ„Å´Âº∑Âà∂ÂêåÊúü
  (add-hook 'after-save-hook
            (lambda ()
              (when (and (buffer-file-name)
                         (string-match-p "RoamNotes" (buffer-file-name)))
                (org-roam-db-sync))))

  ;; Doom Emacs„ÅÆ„Éá„Éï„Ç©„É´„Éànotes„Ç≠„Éº„Éê„Ç§„É≥„Éâ„ÇíÁÑ°ÂäπÂåñ
  (map! :leader
        :prefix "n"
        "f" nil    ; Doom „Éá„Éï„Ç©„É´„Éà„ÇíÁÑ°ÂäπÂåñ
        "d" nil    ; Doom „Éá„Éï„Ç©„É´„Éà„ÇíÁÑ°ÂäπÂåñ
        "l" nil)   ; Doom „Éá„Éï„Ç©„É´„Éà„ÇíÁÑ°ÂäπÂåñ
#+end_src

* Org Agenda with Roam

Settings for managing my schedule and TODOs with org agenda + org-roam

#+begin_src elisp
(use-package! org
  :config
  ;; A. Âü∫Êú¨Ë®≠ÂÆö („Éï„Ç°„Ç§„É´„Éë„Çπ„ÄÅTODO„Ç≠„Éº„ÉØ„Éº„Éâ„ÄÅ„Çø„Ç∞„ÄÅ„Ç¢„Éº„Ç´„Ç§„Éñ)
  ;; -----------------------------------------------------------------
  (setq org-agenda-files '("~/org/agenda" "~/org-roam"))

  ;; Agenda„Éì„É•„Éº„Çí„Ç´„É¨„É≥„Éà„Ç¶„Ç£„É≥„Éâ„Ç¶„ÅßÈñã„Åè
  (setq org-agenda-window-setup 'current-window)

  ;; SOMEDAY: „ÅÑ„Å§„Åã„ÇÑ„Çã / WAIT: Ë™∞„Åã„ÅÆËøî‰∫ãÂæÖ„Å°„Å™„Å©
  (setq org-todo-keywords
        '((sequence "TODO(t)" "PROG(p)" "WAIT(w)" "|" "DONE(d)")
          (sequence "SOMEDAY(s)" "|" "CANCELLED(c)")))

  (setq org-tag-persistent-alist
        '(("@work" . ?w) ("@home" . ?h) ("@errand" . ?e)
          ("@must" . ?m) ("@should" . ?s) ("@want" . ?t)))

  (setq org-archive-location "~/Documents/org/agenda/archive/%s_archive::")

  (after! org-capture
    (setq org-capture-templates
          '(("t" "Task to Inbox" entry
             (file+headline "~/Documents/org/agenda/inbox.org" "Tasks")
             "* TODO %?")

            ("p" "Project Task" entry
             (file+headline "~/Documents/org/agenda/gtd.org" "Projects")
             "* TODO %? :@work:\nSCHEDULED: %(org-insert-time-stamp (current-time) t)\n")

            ("r" "Routine Task" entry
             (file+headline "~/Documents/org/agenda/routines.org" "Routines")
             "* TODO %? \nSCHEDULED: <> \n:PROPERTIES:\n:STYLE: habit\n:END:")

            ("s" "Someday/Maybe" entry
             (file+headline "~/Documents/org/agenda/someday.org" "Ideas")
             "* SOMEDAY %?\n")
            )))

  ;; Êó•‰ªò„Éï„Ç©„Éº„Éû„ÉÉ„Éà„Å®ÁèæÂú®Êó•ÊôÇ„ÅÆË®≠ÂÆö
  (setq org-agenda-start-on-weekday nil)
  (setq org-agenda-start-day nil)
  (setq org-agenda-skip-deadline-if-done t)
  (setq org-agenda-skip-scheduled-if-done t)
  (setq org-agenda-skip-timestamp-if-done t)

  (setq org-agenda-custom-commands
        '(("d" "‚ö° Daily Dashboard"
           ((tags-todo "+DEADLINE<=\"<today>\"|+SCHEDULED<=\"<today>\""
                       ((org-agenda-overriding-header "üéØ Today's Focus Tasks")))))

          ("w" "üîç Weekly Review"
           ((agenda "" ((org-agenda-span 'week)))
            (tags-todo "/DONE"
                       ((org-agenda-overriding-header "Inbox (to be processed)")
                        (org-agenda-files '("~/Documents/org/agenda/inbox.org"))))
            (tags-todo "+DEADLINE>=\"<today>\"+DEADLINE<=\"<+1w>\""
                       ((org-agenda-overriding-header "üî• Deadlines This Week")))
            (tags "project"
                  ((org-agenda-overriding-header "Project Status")))))

          ("s" "üí° Someday / Maybe"
           ((todo "SOMEDAY" ; <- SOMEDAY„Ç≠„Éº„ÉØ„Éº„Éâ„ÅÆ„Çø„Çπ„ÇØ„ÇíÂÖ®„Éï„Ç°„Ç§„É´„Åã„ÇâÊé¢„Åô
                       ((org-agenda-overriding-header "On Hold Tasks (by Keyword)")))
            (tags-todo "/DONE" ; <- someday.org„ÅÆ‰∏≠„ÅÆ„Çø„Çπ„ÇØ„ÇíË°®Á§∫„Åô„Çã
                       ((org-agenda-overriding-header "Idea List (in someday.org)")
                            (org-agenda-files '("~/Documents/org/agenda/someday.org"))))))
          ("A" "All Tasks"
           ((todo "TODO"
                  ((org-agenda-overriding-header "All TODO Tasks")))
            (todo "PROG"
                  ((org-agenda-overriding-header "In Progress")))
            (todo "WAIT"
                  ((org-agenda-overriding-header "Waiting for...")))))
          ))

  ;; „Ç≠„Éº„Éê„Ç§„É≥„Éâ
  (map! :leader
        "o a" 'org-agenda
        "o c" 'org-capture))
#+end_src

* GPTel Keybinds
:PROPERTIES:
:ORDERED:  t
:END:
#+begin_src emacs-lisp
(map! :leader
      :desc "Run GPTel" "c g" #'gptel
      :desc "GPTel menu" "m g" #'gptel-menu
      :desc "GPTel rewrite" "r g" #'gptel-rewrite
      :desc "GPT Chat" "s g" #'gptel-send)
#+end_src

#+begin_src emacs-lisp
(defun +open-vterm ()
  "Open a new vterm in a vertical split or switch to it."
  (interactive)
  (if (get-buffer "*vterm*")
      (pop-to-buffer "*vterm*")
    (select-window (split-window-right))
    (vterm)))

(defun +vterm-switch ()
  "Switch to the most recent vterm buffer."
  (interactive)
  (if-let ((buf (car (seq-filter
                      (lambda (b) (string-match-p "\\*vterm" (buffer-name b)))
                      (buffer-list)))))
      (pop-to-buffer buf)
    (message "No vterm buffer found.")))
#+end_src

* System Configuration

** Platform Specific Settings

#+begin_src emacs-lisp
;; macOSÂ∞ÇÁî®Ë®≠ÂÆö
(when (eq system-type 'darwin)
  (add-to-list 'default-frame-alist '(ns-transparent-titlebar . t))
  (add-to-list 'default-frame-alist '(ns-appearance . dark))
  ;; „Ç∑„Çπ„ÉÜ„É†‰æùÂ≠ò„ÅÆ„Éë„ÇπË®≠ÂÆö„ÅØÁí∞Â¢É„Å´Âêà„Çè„Åõ„Å¶Â§âÊõ¥„Åó„Å¶„Åè„Å†„Åï„ÅÑ
  ;; (setenv "PATH" (concat "XXX:" (getenv "PATH")))
  ;; (add-to-list 'exec-path "XXX")
  )

;; LinuxÂ∞ÇÁî®Ë®≠ÂÆö
(when (eq system-type 'gnu/linux)
  ;; ÂøÖË¶Å„Å´Âøú„Åò„Å¶LinuxÂ∞ÇÁî®„ÅÆË®≠ÂÆö„Çí„Åì„Åì„Å´ËøΩÂä†
  ;; ‰æã: PostgreSQL„ÅÆ„Éë„ÇπË®≠ÂÆö„Å™„Å©
  ;; (setenv "PATH" (concat "/usr/bin:" (getenv "PATH")))
  )
#+end_src

* vterm
#+begin_src emacs-lisp
(after! vterm
  (setq vterm-shell "/bin/zsh")  ;; Replace with your preferred shell
  (setq vterm-max-scrollback 10000)
  (setq vterm-kill-buffer-on-exit t))
#+end_src

** vterm integration
#+begin_src emacs-lisp
(after! vterm
  (set-popup-rule! "*doom:vterm-popup:*"
    :size 0.30
    :vslot -4
    :select t
    :quit nil
    :ttl 0
    :side 'right)
  (setq vterm-shell "/bin/zsh")
  (setq vterm-max-scrollback 10000
        vterm-kill-buffer-on-exit t))
(map! :leader
      :desc "Toggle vterm popup" "o t" #'+vterm/toggle
      :desc "Open vterm here"    "o T" #'+vterm/here)
#+end_src

** opencode with vterm
#+begin_src emacs-lisp
(map! :leader
      :desc "Opencode in terminal" "o o"
      (lambda ()
        (interactive)
        (+vterm/here)
        (vterm-send-string "opencode")
        (vterm-send-return)))
#+end_src

* GPTel Setup
:PROPERTIES:
:tangle: config.el
:END:
#+begin_src emacs-lisp
(use-package! gptel
  :after request
  :config
  (setq! gptel-api-key (getenv "OPENAI_API_KEY"))
  (setq! gptel-backend
         (gptel-make-openai
          :name    "OpenAI"
          :api-key gptel-api-key
          :model   "gpt-4"
          :host    "https://api.openai.com"
          :path    "/v1/chat/completions"
          :params  '((:temperature . 0.7)
                     (:max_tokens  . 1024))))
  (after! org
    (setq! gptel-org-auto-set-properties t)))
#+end_src

* Emacs window tiling fix
#+begin_src emacs-lisp
(menu-bar-mode -1)
#+end_src

* Keybinding fixes & OpenCode integration
#+begin_src emacs-lisp
(defun my/vterm-here-safe (&optional arg)
  "Safely call +vterm/here with optional ARG."
  (interactive "P")
  (+vterm/here arg))

(map! :leader
      :desc "Toggle vterm popup"    "o t" #'+vterm/toggle
      :desc "Open inline vterm"     "o T" #'my/vterm-here-safe)
#+end_src

* ivy-posframe config
#+begin_src emacs-lisp
(use-package! ivy-posframe
  :after ivy
  :init
  (ivy-posframe-mode 1)
  :config
  (setq ivy-posframe-display-functions-alist
        '((t . ivy-posframe-display-at-frame-center)))
  (setq ivy-posframe-parameters
        '((internal-border-width . 10)
          (left-fringe . 8)
          (right-fringe . 8))))
#+end_src

* Ivy Mode
Force ivy-mode to start early
#+begin_src emacs-lisp
(after! ivy
  (ivy-mode 1)
  (setq ivy-use-virtual-buffers t
        ivy-count-format "(%d/%d) "
        enable-recursive-minibuffers t))
#+end_src

* Auto tangle
#+begin_src emacs-lisp
(defun config-org-auto-tangle ()
  (when (string-equal (buffer-file-name)
                      (expand-file-name "~/.doom.d/config.org"))
    (org-babel-tangle)))

;;text
(add-hook 'after-save-hook #'config-org-auto-tangle)
#+end_src

